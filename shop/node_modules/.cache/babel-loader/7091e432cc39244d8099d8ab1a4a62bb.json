{"ast":null,"code":"var _jsxFileName = \"/var/www/html/check/javascript-shop/client.v1/src/components/UpdateProduct.js\",\n    _s = $RefreshSig$();\n\nimport { Modal, Button, Form, Row, Col } from 'react-bootstrap';\nimport { fetchOneProduct, updateProduct, fetchCategories, fetchBrands } from '../http/catalogAPI.js';\nimport { useState, useEffect } from 'react';\nimport uuid from 'react-uuid';\nimport UpdateProperties from './UpdateProperties.js';\nimport { createProperty, updateProperty, deleteProperty } from '../http/catalogAPI.js';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst defaultValue = {\n  name: '',\n  price: '',\n  category: '',\n  brand: ''\n};\nconst defaultValid = {\n  name: null,\n  price: null,\n  category: null,\n  brand: null\n};\n\nconst isValid = value => {\n  const result = {};\n  const pattern = /^[1-9][0-9]*$/;\n\n  for (let key in value) {\n    if (key === 'name') result.name = value.name.trim() !== '';\n    if (key === 'price') result.price = pattern.test(value.price.trim());\n    if (key === 'category') result.category = pattern.test(value.category);\n    if (key === 'brand') result.brand = pattern.test(value.brand);\n  }\n\n  return result;\n};\n\nconst updateProperties = async (properties, productId) => {\n  for (const prop of properties) {\n    const empty = prop.name.trim() === '' || prop.value.trim() === ''; // если вдруг старая хар-ка оказалась пустая — удалим ее на сервере\n\n    if (empty && prop.id) {\n      try {\n        await deleteProperty(productId, prop);\n      } catch (error) {\n        alert(error.response.data.message);\n      }\n\n      continue;\n    }\n    /*\n     * Если у объекта prop свойство append равно true — это новая хар-ка, ее надо создать.\n     * Если у объекта prop свойство change равно true — хар-ка изменилась, ее надо обновить.\n     * Если у объекта prop свойство remove равно true — хар-ку удалили, ее надо удалить.\n     */\n\n\n    if (prop.append && !empty) {\n      try {\n        await createProperty(productId, prop);\n      } catch (error) {\n        alert(error.response.data.message);\n      }\n\n      continue;\n    }\n\n    if (prop.change && !prop.remove) {\n      try {\n        await updateProperty(productId, prop.id, prop);\n      } catch (error) {\n        alert(error.response.data.message);\n      }\n\n      continue;\n    }\n\n    if (prop.remove) {\n      try {\n        await deleteProperty(productId, prop.id);\n      } catch (error) {\n        alert(error.response.data.message);\n      }\n\n      continue;\n    }\n  }\n};\n\nconst UpdateProduct = props => {\n  _s();\n\n  const {\n    id,\n    show,\n    setShow,\n    setChange\n  } = props;\n  const [value, setValue] = useState(defaultValue);\n  const [valid, setValid] = useState(defaultValid); // список категорий и список брендов для возможности выбора\n\n  const [categories, setCategories] = useState(null);\n  const [brands, setBrands] = useState(null); // выбранное для загрузки изображение товара\n\n  const [image, setImage] = useState(null); // список характеристик товара\n\n  const [properties, setProperties] = useState([]);\n  useEffect(() => {\n    if (id) {\n      // нужно получить с сервера данные товара для редактирования\n      fetchOneProduct(id).then(data => {\n        const prod = {\n          name: data.name,\n          price: data.price.toString(),\n          category: data.categoryId.toString(),\n          brand: data.brandId.toString()\n        };\n        setValue(prod);\n        setValid(isValid(prod)); // для удобства работы с хар-ми зададим для каждой уникальный идентификатор\n        // и доп.свойства, которые подскажут нам, какой http-запрос на сервер нужно\n        // выполнить — добавления, обновления или удаления характеристики\n\n        setProperties(data.props.map(item => {\n          // при добавлении новой хар-ки свойство append принимает значение true\n          // при изменении старой хар-ки свойство change принимает значение true\n          // при удалении старой хар-ки свойство remove принимает значение true\n          return { ...item,\n            unique: uuid(),\n            append: false,\n            remove: false,\n            change: false\n          };\n        }));\n      }).catch(error => alert(error.response.data.message)); // нужно получить с сервера список категорий и список брендов\n\n      fetchCategories().then(data => setCategories(data));\n      fetchBrands().then(data => setBrands(data));\n    }\n  }, [id]);\n\n  const handleInputChange = event => {\n    const data = { ...value,\n      [event.target.name]: event.target.value\n    };\n    setValue(data);\n    setValid(isValid(data));\n  };\n\n  const handleImageChange = event => {\n    setImage(event.target.files[0]);\n  };\n\n  const handleSubmit = async event => {\n    event.preventDefault();\n    /*\n     * На первый взгляд кажется, что переменная correct не нужна, можно обойтись valid, но это\n     * не так. Нельзя использовать значение valid сразу после изменения этого значения — ф-ция\n     * setValid не изменяет значение состояния мгновенно. Вызов функции лишь означает — React\n     * «принял к сведению» наше сообщение, что состояние нужно изменить.\n     */\n\n    const correct = isValid(value);\n    setValid(correct); // если введенные данные прошли проверку — можно отправлять их на сервер\n\n    if (correct.name && correct.price && correct.category && correct.brand) {\n      const data = new FormData();\n      data.append('name', value.name.trim());\n      data.append('price', value.price.trim());\n      data.append('categoryId', value.category);\n      data.append('brandId', value.brand);\n      if (image) data.append('image', image, image.name); // нужно обновить, добавить или удалить характеристики и обязательно дождаться\n      // ответа сервера — поэтому функция updateProperties() объявлена как async, а\n      // в теле функции для выполнения действия с каждой хар-кой используется await\n\n      if (properties.length) {\n        await updateProperties(properties, id);\n      }\n\n      updateProduct(id, data).then(data => {\n        // сбрасываем поле загрузки изображения, чтобы при сохранении товара,\n        // когда новое изображение не выбрано, не загружать старое повтороно\n        event.target.image.value = ''; // в принципе, мы могли бы сбросить все поля формы на дефолтные значения, но\n        // если пользователь решит отредатировать тот же товар повтороно, то увидит\n        // пустые поля формы — http-запрос на получение данных для редактирования мы\n        // выполняем только тогда, когда выбран новый товар (изменился id товара)\n\n        const prod = {\n          name: data.name,\n          price: data.price.toString(),\n          category: data.categoryId.toString(),\n          brand: data.brandId.toString()\n        };\n        setValue(prod);\n        setValid(isValid(prod)); // мы получим актуальные значения хар-тик с сервера, потому что обновление\n        // хар-тик завершилось еще до момента отправки этого http-запроса на сервер\n\n        setProperties(data.props.map(item => {\n          return { ...item,\n            unique: uuid(),\n            append: false,\n            remove: false,\n            change: false\n          };\n        })); // закрываем модальное окно редактирования товара\n\n        setShow(false); // изменяем состояние, чтобы обновить список товаров\n\n        setChange(state => !state);\n      }).catch(error => alert(error.response.data.message));\n    }\n  };\n\n  return /*#__PURE__*/_jsxDEV(Modal, {\n    show: show,\n    onHide: () => setShow(false),\n    size: \"lg\",\n    children: [/*#__PURE__*/_jsxDEV(Modal.Header, {\n      closeButton: true,\n      children: /*#__PURE__*/_jsxDEV(Modal.Title, {\n        children: \"\\u0420\\u0435\\u0434\\u0430\\u043A\\u0442\\u0438\\u0440\\u043E\\u0432\\u0430\\u043D\\u0438\\u0435 \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 199,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 198,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(Modal.Body, {\n      children: /*#__PURE__*/_jsxDEV(Form, {\n        noValidate: true,\n        onSubmit: handleSubmit,\n        children: [/*#__PURE__*/_jsxDEV(Form.Control, {\n          name: \"name\",\n          value: value.name,\n          onChange: e => handleInputChange(e),\n          isValid: valid.name === true,\n          isInvalid: valid.name === false,\n          placeholder: \"\\u041D\\u0430\\u0437\\u0432\\u0430\\u043D\\u0438\\u0435 \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430...\",\n          className: \"mb-3\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 204,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Row, {\n          className: \"mb-3\",\n          children: [/*#__PURE__*/_jsxDEV(Col, {\n            children: /*#__PURE__*/_jsxDEV(Form.Select, {\n              name: \"category\",\n              value: value.category,\n              onChange: e => handleInputChange(e),\n              isValid: valid.category === true,\n              isInvalid: valid.category === false,\n              children: [/*#__PURE__*/_jsxDEV(\"option\", {\n                value: \"\",\n                children: \"\\u041A\\u0430\\u0442\\u0435\\u0433\\u043E\\u0440\\u0438\\u044F\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 222,\n                columnNumber: 33\n              }, this), categories && categories.map(item => /*#__PURE__*/_jsxDEV(\"option\", {\n                value: item.id,\n                children: item.name\n              }, item.id, false, {\n                fileName: _jsxFileName,\n                lineNumber: 224,\n                columnNumber: 37\n              }, this))]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 215,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 214,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(Col, {\n            children: /*#__PURE__*/_jsxDEV(Form.Select, {\n              name: \"brand\",\n              value: value.brand,\n              onChange: e => handleInputChange(e),\n              isValid: valid.brand === true,\n              isInvalid: valid.brand === false,\n              children: [/*#__PURE__*/_jsxDEV(\"option\", {\n                value: \"\",\n                children: \"\\u0411\\u0440\\u0435\\u043D\\u0434\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 236,\n                columnNumber: 33\n              }, this), brands && brands.map(item => /*#__PURE__*/_jsxDEV(\"option\", {\n                value: item.id,\n                children: item.name\n              }, item.id, false, {\n                fileName: _jsxFileName,\n                lineNumber: 238,\n                columnNumber: 37\n              }, this))]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 229,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 228,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 213,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Row, {\n          className: \"mb-3\",\n          children: [/*#__PURE__*/_jsxDEV(Col, {\n            children: /*#__PURE__*/_jsxDEV(Form.Control, {\n              name: \"price\",\n              value: value.price,\n              onChange: e => handleInputChange(e),\n              isValid: valid.price === true,\n              isInvalid: valid.price === false,\n              placeholder: \"\\u0426\\u0435\\u043D\\u0430 \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430...\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 245,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 244,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(Col, {\n            children: /*#__PURE__*/_jsxDEV(Form.Control, {\n              name: \"image\",\n              type: \"file\",\n              onChange: e => handleImageChange(e),\n              placeholder: \"\\u0424\\u043E\\u0442\\u043E \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430...\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 255,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 254,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 243,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(UpdateProperties, {\n          properties: properties,\n          setProperties: setProperties\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 263,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Row, {\n          children: /*#__PURE__*/_jsxDEV(Col, {\n            children: /*#__PURE__*/_jsxDEV(Button, {\n              type: \"submit\",\n              children: \"\\u0421\\u043E\\u0445\\u0440\\u0430\\u043D\\u0438\\u0442\\u044C\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 266,\n              columnNumber: 29\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 265,\n            columnNumber: 25\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 264,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 203,\n        columnNumber: 17\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 202,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 197,\n    columnNumber: 9\n  }, this);\n};\n\n_s(UpdateProduct, \"e+3N9tVxQgG2+gsYp5b/Wh81eTo=\");\n\n_c = UpdateProduct;\nexport default UpdateProduct;\n\nvar _c;\n\n$RefreshReg$(_c, \"UpdateProduct\");","map":{"version":3,"sources":["/var/www/html/check/javascript-shop/client.v1/src/components/UpdateProduct.js"],"names":["Modal","Button","Form","Row","Col","fetchOneProduct","updateProduct","fetchCategories","fetchBrands","useState","useEffect","uuid","UpdateProperties","createProperty","updateProperty","deleteProperty","defaultValue","name","price","category","brand","defaultValid","isValid","value","result","pattern","key","trim","test","updateProperties","properties","productId","prop","empty","id","error","alert","response","data","message","append","change","remove","UpdateProduct","props","show","setShow","setChange","setValue","valid","setValid","categories","setCategories","brands","setBrands","image","setImage","setProperties","then","prod","toString","categoryId","brandId","map","item","unique","catch","handleInputChange","event","target","handleImageChange","files","handleSubmit","preventDefault","correct","FormData","length","state","e"],"mappings":"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","sourcesContent":["import { Modal, Button, Form, Row, Col } from 'react-bootstrap'\nimport { fetchOneProduct, updateProduct, fetchCategories, fetchBrands } from '../http/catalogAPI.js'\nimport { useState, useEffect } from 'react'\nimport uuid from 'react-uuid'\nimport UpdateProperties from './UpdateProperties.js'\nimport { createProperty, updateProperty, deleteProperty } from '../http/catalogAPI.js'\n\nconst defaultValue = {name: '', price: '', category: '', brand: ''}\nconst defaultValid = {name: null, price: null, category: null, brand: null}\n\nconst isValid = (value) => {\n    const result = {}\n    const pattern = /^[1-9][0-9]*$/\n    for (let key in value) {\n        if (key === 'name') result.name = value.name.trim() !== ''\n        if (key === 'price') result.price = pattern.test(value.price.trim())\n        if (key === 'category') result.category = pattern.test(value.category)\n        if (key === 'brand') result.brand = pattern.test(value.brand)\n    }\n    return result\n}\n\nconst updateProperties = async (properties, productId) => {\n    for (const prop of properties) {\n        const empty = prop.name.trim() === '' || prop.value.trim() === ''\n        // если вдруг старая хар-ка оказалась пустая — удалим ее на сервере\n        if (empty && prop.id) {\n            try {\n                await deleteProperty(productId, prop)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n        /*\n         * Если у объекта prop свойство append равно true — это новая хар-ка, ее надо создать.\n         * Если у объекта prop свойство change равно true — хар-ка изменилась, ее надо обновить.\n         * Если у объекта prop свойство remove равно true — хар-ку удалили, ее надо удалить.\n         */\n        if (prop.append && !empty) {\n            try {\n                await createProperty(productId, prop)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n        if (prop.change && !prop.remove) {\n            try {\n                await updateProperty(productId, prop.id, prop)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n        if (prop.remove) {\n            try {\n                await deleteProperty(productId, prop.id)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n    }\n}\n\nconst UpdateProduct = (props) => {\n    const { id, show, setShow, setChange } = props\n\n    const [value, setValue] = useState(defaultValue)\n    const [valid, setValid] = useState(defaultValid)\n\n    // список категорий и список брендов для возможности выбора\n    const [categories, setCategories] = useState(null)\n    const [brands, setBrands] = useState(null)\n\n    // выбранное для загрузки изображение товара\n    const [image, setImage] = useState(null)\n\n    // список характеристик товара\n    const [properties, setProperties] = useState([])\n\n    useEffect(() => {\n        if(id) {\n            // нужно получить с сервера данные товара для редактирования\n            fetchOneProduct(id)\n                .then(\n                    data => {\n                        const prod = {\n                            name: data.name,\n                            price: data.price.toString(),\n                            category: data.categoryId.toString(),\n                            brand: data.brandId.toString()\n                        }\n                        setValue(prod)\n                        setValid(isValid(prod))\n                        // для удобства работы с хар-ми зададим для каждой уникальный идентификатор\n                        // и доп.свойства, которые подскажут нам, какой http-запрос на сервер нужно\n                        // выполнить — добавления, обновления или удаления характеристики\n                        setProperties(data.props.map(item => {\n                            // при добавлении новой хар-ки свойство append принимает значение true\n                            // при изменении старой хар-ки свойство change принимает значение true\n                            // при удалении старой хар-ки свойство remove принимает значение true\n                            return {...item, unique: uuid(), append: false, remove: false, change: false}\n                        }))\n                    }\n                )\n                .catch(\n                    error => alert(error.response.data.message)\n                )\n            // нужно получить с сервера список категорий и список брендов\n            fetchCategories()\n                .then(\n                    data => setCategories(data)\n                )\n            fetchBrands()\n                .then(\n                    data => setBrands(data)\n                )\n        }\n    }, [id])\n\n    const handleInputChange = (event) => {\n        const data = {...value, [event.target.name]: event.target.value}\n        setValue(data)\n        setValid(isValid(data))\n    }\n\n    const handleImageChange = (event) => {\n        setImage(event.target.files[0])\n    }\n\n    const handleSubmit = async (event) => {\n        event.preventDefault()\n\n        /*\n         * На первый взгляд кажется, что переменная correct не нужна, можно обойтись valid, но это\n         * не так. Нельзя использовать значение valid сразу после изменения этого значения — ф-ция\n         * setValid не изменяет значение состояния мгновенно. Вызов функции лишь означает — React\n         * «принял к сведению» наше сообщение, что состояние нужно изменить.\n         */\n        const correct = isValid(value)\n        setValid(correct)\n\n        // если введенные данные прошли проверку — можно отправлять их на сервер\n        if (correct.name && correct.price && correct.category && correct.brand) {\n            const data = new FormData()\n            data.append('name', value.name.trim())\n            data.append('price', value.price.trim())\n            data.append('categoryId', value.category)\n            data.append('brandId', value.brand)\n            if (image) data.append('image', image, image.name)\n\n            // нужно обновить, добавить или удалить характеристики и обязательно дождаться\n            // ответа сервера — поэтому функция updateProperties() объявлена как async, а\n            // в теле функции для выполнения действия с каждой хар-кой используется await\n            if (properties.length) {\n                await updateProperties(properties, id)\n            }\n\n            updateProduct(id, data)\n                .then(\n                    data => {\n                        // сбрасываем поле загрузки изображения, чтобы при сохранении товара,\n                        // когда новое изображение не выбрано, не загружать старое повтороно\n                        event.target.image.value = ''\n                        // в принципе, мы могли бы сбросить все поля формы на дефолтные значения, но\n                        // если пользователь решит отредатировать тот же товар повтороно, то увидит\n                        // пустые поля формы — http-запрос на получение данных для редактирования мы\n                        // выполняем только тогда, когда выбран новый товар (изменился id товара)\n                        const prod = {\n                            name: data.name,\n                            price: data.price.toString(),\n                            category: data.categoryId.toString(),\n                            brand: data.brandId.toString()\n                        }\n                        setValue(prod)\n                        setValid(isValid(prod))\n                        // мы получим актуальные значения хар-тик с сервера, потому что обновление\n                        // хар-тик завершилось еще до момента отправки этого http-запроса на сервер\n                        setProperties(data.props.map(item => {\n                            return {...item, unique: uuid(), append: false, remove: false, change: false}\n                        }))\n                        // закрываем модальное окно редактирования товара\n                        setShow(false)\n                        // изменяем состояние, чтобы обновить список товаров\n                        setChange(state => !state)\n                    }\n                )\n                .catch(\n                    error => alert(error.response.data.message)\n                )\n        }\n    }\n\n    return (\n        <Modal show={show} onHide={() => setShow(false)} size=\"lg\">\n            <Modal.Header closeButton>\n                <Modal.Title>Редактирование товара</Modal.Title>\n            </Modal.Header>\n\n            <Modal.Body>\n                <Form noValidate onSubmit={handleSubmit}>\n                    <Form.Control\n                        name=\"name\"\n                        value={value.name}\n                        onChange={e => handleInputChange(e)}\n                        isValid={valid.name === true}\n                        isInvalid={valid.name === false}\n                        placeholder=\"Название товара...\"\n                        className=\"mb-3\"\n                    />\n                    <Row className=\"mb-3\">\n                        <Col>\n                            <Form.Select\n                                name=\"category\"\n                                value={value.category}\n                                onChange={e => handleInputChange(e)}\n                                isValid={valid.category === true}\n                                isInvalid={valid.category === false}\n                            >\n                                <option value=\"\">Категория</option>\n                                {categories && categories.map(item =>\n                                    <option key={item.id} value={item.id}>{item.name}</option>\n                                )}\n                            </Form.Select>\n                        </Col>\n                        <Col>\n                            <Form.Select\n                                name=\"brand\"\n                                value={value.brand}\n                                onChange={e => handleInputChange(e)}\n                                isValid={valid.brand === true}\n                                isInvalid={valid.brand === false}\n                            >\n                                <option value=\"\">Бренд</option>\n                                {brands && brands.map(item =>\n                                    <option key={item.id} value={item.id}>{item.name}</option>\n                                )}\n                            </Form.Select>\n                        </Col>\n                    </Row>\n                    <Row className=\"mb-3\">\n                        <Col>\n                            <Form.Control\n                                name=\"price\"\n                                value={value.price}\n                                onChange={e => handleInputChange(e)}\n                                isValid={valid.price === true}\n                                isInvalid={valid.price === false}\n                                placeholder=\"Цена товара...\"\n                            />\n                        </Col>\n                        <Col>\n                            <Form.Control\n                                name=\"image\"\n                                type=\"file\"\n                                onChange={e => handleImageChange(e)}\n                                placeholder=\"Фото товара...\"\n                            />\n                        </Col>\n                    </Row>\n                    <UpdateProperties properties={properties} setProperties={setProperties} />\n                    <Row>\n                        <Col>\n                            <Button type=\"submit\">Сохранить</Button>\n                        </Col>\n                    </Row>\n                </Form>\n            </Modal.Body>\n        </Modal>\n    )\n}\n\nexport default UpdateProduct"]},"metadata":{},"sourceType":"module"}