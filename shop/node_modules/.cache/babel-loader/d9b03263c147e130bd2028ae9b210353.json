{"ast":null,"code":"import _defineProperty from\"/var/www/html/check/javascript-shop/client.v1/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";import _objectSpread from\"/var/www/html/check/javascript-shop/client.v1/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/var/www/html/check/javascript-shop/client.v1/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"/var/www/html/check/javascript-shop/client.v1/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _asyncToGenerator from\"/var/www/html/check/javascript-shop/client.v1/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _regeneratorRuntime from\"/var/www/html/check/javascript-shop/client.v1/node_modules/@babel/runtime/regenerator/index.js\";import{Modal,Button,Form,Row,Col}from'react-bootstrap';import{fetchOneProduct,updateProduct,fetchCategories,fetchBrands}from'../http/catalogAPI.js';import{useState,useEffect}from'react';import uuid from'react-uuid';import UpdateProperties from'./UpdateProperties.js';import{createProperty,updateProperty,deleteProperty}from'../http/catalogAPI.js';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var defaultValue={name:'',price:'',category:'',brand:''};var defaultValid={name:null,price:null,category:null,brand:null};var isValid=function isValid(value){var result={};var pattern=/^[1-9][0-9]*$/;for(var key in value){if(key==='name')result.name=value.name.trim()!=='';if(key==='price')result.price=pattern.test(value.price.trim());if(key==='category')result.category=pattern.test(value.category);if(key==='brand')result.brand=pattern.test(value.brand);}return result;};var updateProperties=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(properties,productId){var _iterator,_step,prop,empty;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_iterator=_createForOfIteratorHelper(properties);_context.prev=1;_iterator.s();case 3:if((_step=_iterator.n()).done){_context.next=48;break;}prop=_step.value;empty=prop.name.trim()===''||prop.value.trim()==='';// если вдруг старая хар-ка оказалась пустая — удалим ее на сервере\nif(!(empty&&prop.id)){_context.next=16;break;}_context.prev=7;_context.next=10;return deleteProperty(productId,prop);case 10:_context.next=15;break;case 12:_context.prev=12;_context.t0=_context[\"catch\"](7);alert(_context.t0.response.data.message);case 15:return _context.abrupt(\"continue\",46);case 16:if(!(prop.append&&!empty)){_context.next=26;break;}_context.prev=17;_context.next=20;return createProperty(productId,prop);case 20:_context.next=25;break;case 22:_context.prev=22;_context.t1=_context[\"catch\"](17);alert(_context.t1.response.data.message);case 25:return _context.abrupt(\"continue\",46);case 26:if(!(prop.change&&!prop.remove)){_context.next=36;break;}_context.prev=27;_context.next=30;return updateProperty(productId,prop.id,prop);case 30:_context.next=35;break;case 32:_context.prev=32;_context.t2=_context[\"catch\"](27);alert(_context.t2.response.data.message);case 35:return _context.abrupt(\"continue\",46);case 36:if(!prop.remove){_context.next=46;break;}_context.prev=37;_context.next=40;return deleteProperty(productId,prop.id);case 40:_context.next=45;break;case 42:_context.prev=42;_context.t3=_context[\"catch\"](37);alert(_context.t3.response.data.message);case 45:return _context.abrupt(\"continue\",46);case 46:_context.next=3;break;case 48:_context.next=53;break;case 50:_context.prev=50;_context.t4=_context[\"catch\"](1);_iterator.e(_context.t4);case 53:_context.prev=53;_iterator.f();return _context.finish(53);case 56:case\"end\":return _context.stop();}}},_callee,null,[[1,50,53,56],[7,12],[17,22],[27,32],[37,42]]);}));return function updateProperties(_x,_x2){return _ref.apply(this,arguments);};}();var UpdateProduct=function UpdateProduct(props){var id=props.id,show=props.show,setShow=props.setShow,setChange=props.setChange;var _useState=useState(defaultValue),_useState2=_slicedToArray(_useState,2),value=_useState2[0],setValue=_useState2[1];var _useState3=useState(defaultValid),_useState4=_slicedToArray(_useState3,2),valid=_useState4[0],setValid=_useState4[1];// список категорий и список брендов для возможности выбора\nvar _useState5=useState(null),_useState6=_slicedToArray(_useState5,2),categories=_useState6[0],setCategories=_useState6[1];var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),brands=_useState8[0],setBrands=_useState8[1];// выбранное для загрузки изображение товара\nvar _useState9=useState(null),_useState10=_slicedToArray(_useState9,2),image=_useState10[0],setImage=_useState10[1];// список характеристик товара\nvar _useState11=useState([]),_useState12=_slicedToArray(_useState11,2),properties=_useState12[0],setProperties=_useState12[1];useEffect(function(){if(id){// нужно получить с сервера данные товара для редактирования\nfetchOneProduct(id).then(function(data){var prod={name:data.name,price:data.price.toString(),category:data.categoryId.toString(),brand:data.brandId.toString()};setValue(prod);setValid(isValid(prod));// для удобства работы с хар-ми зададим для каждой уникальный идентификатор\n// и доп.свойства, которые подскажут нам, какой http-запрос на сервер нужно\n// выполнить — добавления, обновления или удаления характеристики\nsetProperties(data.props.map(function(item){// при добавлении новой хар-ки свойство append принимает значение true\n// при изменении старой хар-ки свойство change принимает значение true\n// при удалении старой хар-ки свойство remove принимает значение true\nreturn _objectSpread(_objectSpread({},item),{},{unique:uuid(),append:false,remove:false,change:false});}));}).catch(function(error){return alert(error.response.data.message);});// нужно получить с сервера список категорий и список брендов\nfetchCategories().then(function(data){return setCategories(data);});fetchBrands().then(function(data){return setBrands(data);});}},[id]);var handleInputChange=function handleInputChange(event){var data=_objectSpread(_objectSpread({},value),{},_defineProperty({},event.target.name,event.target.value));setValue(data);setValid(isValid(data));};var handleImageChange=function handleImageChange(event){setImage(event.target.files[0]);};var handleSubmit=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(event){var correct,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:event.preventDefault();/*\n         * На первый взгляд кажется, что переменная correct не нужна, можно обойтись valid, но это\n         * не так. Нельзя использовать значение valid сразу после изменения этого значения — ф-ция\n         * setValid не изменяет значение состояния мгновенно. Вызов функции лишь означает — React\n         * «принял к сведению» наше сообщение, что состояние нужно изменить.\n         */correct=isValid(value);setValid(correct);// если введенные данные прошли проверку — можно отправлять их на сервер\nif(!(correct.name&&correct.price&&correct.category&&correct.brand)){_context2.next=14;break;}data=new FormData();data.append('name',value.name.trim());data.append('price',value.price.trim());data.append('categoryId',value.category);data.append('brandId',value.brand);if(image)data.append('image',image,image.name);// нужно обновить, добавить или удалить характеристики и обязательно дождаться\n// ответа сервера — поэтому функция updateProperties() объявлена как async, а\n// в теле функции для выполнения действия с каждой хар-кой используется await\nif(!properties.length){_context2.next=13;break;}_context2.next=13;return updateProperties(properties,id);case 13:updateProduct(id,data).then(function(data){// сбрасываем поле загрузки изображения, чтобы при сохранении товара,\n// когда новое изображение не выбрано, не загружать старое повтороно\nevent.target.image.value='';// в принципе, мы могли бы сбросить все поля формы на дефолтные значения, но\n// если пользователь решит отредатировать тот же товар повтороно, то увидит\n// пустые поля формы — http-запрос на получение данных для редактирования мы\n// выполняем только тогда, когда выбран новый товар (изменился id товара)\nvar prod={name:data.name,price:data.price.toString(),category:data.categoryId.toString(),brand:data.brandId.toString()};setValue(prod);setValid(isValid(prod));// мы получим актуальные значения хар-тик с сервера, потому что обновление\n// хар-тик завершилось еще до момента отправки этого http-запроса на сервер\nsetProperties(data.props.map(function(item){return _objectSpread(_objectSpread({},item),{},{unique:uuid(),append:false,remove:false,change:false});}));// закрываем модальное окно редактирования товара\nsetShow(false);// изменяем состояние, чтобы обновить список товаров\nsetChange(function(state){return!state;});}).catch(function(error){return alert(error.response.data.message);});case 14:case\"end\":return _context2.stop();}}},_callee2);}));return function handleSubmit(_x3){return _ref2.apply(this,arguments);};}();return/*#__PURE__*/_jsxs(Modal,{show:show,onHide:function onHide(){return setShow(false);},size:\"lg\",children:[/*#__PURE__*/_jsx(Modal.Header,{closeButton:true,children:/*#__PURE__*/_jsx(Modal.Title,{children:\"\\u0420\\u0435\\u0434\\u0430\\u043A\\u0442\\u0438\\u0440\\u043E\\u0432\\u0430\\u043D\\u0438\\u0435 \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430\"})}),/*#__PURE__*/_jsx(Modal.Body,{children:/*#__PURE__*/_jsxs(Form,{noValidate:true,onSubmit:handleSubmit,children:[/*#__PURE__*/_jsx(Form.Control,{name:\"name\",value:value.name,onChange:function onChange(e){return handleInputChange(e);},isValid:valid.name===true,isInvalid:valid.name===false,placeholder:\"\\u041D\\u0430\\u0437\\u0432\\u0430\\u043D\\u0438\\u0435 \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430...\",className:\"mb-3\"}),/*#__PURE__*/_jsxs(Row,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsxs(Form.Select,{name:\"category\",value:value.category,onChange:function onChange(e){return handleInputChange(e);},isValid:valid.category===true,isInvalid:valid.category===false,children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"\\u041A\\u0430\\u0442\\u0435\\u0433\\u043E\\u0440\\u0438\\u044F\"}),categories&&categories.map(function(item){return/*#__PURE__*/_jsx(\"option\",{value:item.id,children:item.name},item.id);})]})}),/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsxs(Form.Select,{name:\"brand\",value:value.brand,onChange:function onChange(e){return handleInputChange(e);},isValid:valid.brand===true,isInvalid:valid.brand===false,children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"\\u0411\\u0440\\u0435\\u043D\\u0434\"}),brands&&brands.map(function(item){return/*#__PURE__*/_jsx(\"option\",{value:item.id,children:item.name},item.id);})]})})]}),/*#__PURE__*/_jsxs(Row,{className:\"mb-3\",children:[/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Form.Control,{name:\"price\",value:value.price,onChange:function onChange(e){return handleInputChange(e);},isValid:valid.price===true,isInvalid:valid.price===false,placeholder:\"\\u0426\\u0435\\u043D\\u0430 \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430...\"})}),/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Form.Control,{name:\"image\",type:\"file\",onChange:function onChange(e){return handleImageChange(e);},placeholder:\"\\u0424\\u043E\\u0442\\u043E \\u0442\\u043E\\u0432\\u0430\\u0440\\u0430...\"})})]}),/*#__PURE__*/_jsx(UpdateProperties,{properties:properties,setProperties:setProperties}),/*#__PURE__*/_jsx(Row,{children:/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Button,{type:\"submit\",children:\"\\u0421\\u043E\\u0445\\u0440\\u0430\\u043D\\u0438\\u0442\\u044C\"})})})]})})]});};export default UpdateProduct;","map":{"version":3,"sources":["/var/www/html/check/javascript-shop/client.v1/src/components/UpdateProduct.js"],"names":["Modal","Button","Form","Row","Col","fetchOneProduct","updateProduct","fetchCategories","fetchBrands","useState","useEffect","uuid","UpdateProperties","createProperty","updateProperty","deleteProperty","defaultValue","name","price","category","brand","defaultValid","isValid","value","result","pattern","key","trim","test","updateProperties","properties","productId","prop","empty","id","alert","response","data","message","append","change","remove","UpdateProduct","props","show","setShow","setChange","setValue","valid","setValid","categories","setCategories","brands","setBrands","image","setImage","setProperties","then","prod","toString","categoryId","brandId","map","item","unique","catch","error","handleInputChange","event","target","handleImageChange","files","handleSubmit","preventDefault","correct","FormData","length","state","e"],"mappings":"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","sourcesContent":["import { Modal, Button, Form, Row, Col } from 'react-bootstrap'\nimport { fetchOneProduct, updateProduct, fetchCategories, fetchBrands } from '../http/catalogAPI.js'\nimport { useState, useEffect } from 'react'\nimport uuid from 'react-uuid'\nimport UpdateProperties from './UpdateProperties.js'\nimport { createProperty, updateProperty, deleteProperty } from '../http/catalogAPI.js'\n\nconst defaultValue = {name: '', price: '', category: '', brand: ''}\nconst defaultValid = {name: null, price: null, category: null, brand: null}\n\nconst isValid = (value) => {\n    const result = {}\n    const pattern = /^[1-9][0-9]*$/\n    for (let key in value) {\n        if (key === 'name') result.name = value.name.trim() !== ''\n        if (key === 'price') result.price = pattern.test(value.price.trim())\n        if (key === 'category') result.category = pattern.test(value.category)\n        if (key === 'brand') result.brand = pattern.test(value.brand)\n    }\n    return result\n}\n\nconst updateProperties = async (properties, productId) => {\n    for (const prop of properties) {\n        const empty = prop.name.trim() === '' || prop.value.trim() === ''\n        // если вдруг старая хар-ка оказалась пустая — удалим ее на сервере\n        if (empty && prop.id) {\n            try {\n                await deleteProperty(productId, prop)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n        /*\n         * Если у объекта prop свойство append равно true — это новая хар-ка, ее надо создать.\n         * Если у объекта prop свойство change равно true — хар-ка изменилась, ее надо обновить.\n         * Если у объекта prop свойство remove равно true — хар-ку удалили, ее надо удалить.\n         */\n        if (prop.append && !empty) {\n            try {\n                await createProperty(productId, prop)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n        if (prop.change && !prop.remove) {\n            try {\n                await updateProperty(productId, prop.id, prop)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n        if (prop.remove) {\n            try {\n                await deleteProperty(productId, prop.id)\n            } catch(error) {\n                alert(error.response.data.message)\n            }\n            continue\n        }\n    }\n}\n\nconst UpdateProduct = (props) => {\n    const { id, show, setShow, setChange } = props\n\n    const [value, setValue] = useState(defaultValue)\n    const [valid, setValid] = useState(defaultValid)\n\n    // список категорий и список брендов для возможности выбора\n    const [categories, setCategories] = useState(null)\n    const [brands, setBrands] = useState(null)\n\n    // выбранное для загрузки изображение товара\n    const [image, setImage] = useState(null)\n\n    // список характеристик товара\n    const [properties, setProperties] = useState([])\n\n    useEffect(() => {\n        if(id) {\n            // нужно получить с сервера данные товара для редактирования\n            fetchOneProduct(id)\n                .then(\n                    data => {\n                        const prod = {\n                            name: data.name,\n                            price: data.price.toString(),\n                            category: data.categoryId.toString(),\n                            brand: data.brandId.toString()\n                        }\n                        setValue(prod)\n                        setValid(isValid(prod))\n                        // для удобства работы с хар-ми зададим для каждой уникальный идентификатор\n                        // и доп.свойства, которые подскажут нам, какой http-запрос на сервер нужно\n                        // выполнить — добавления, обновления или удаления характеристики\n                        setProperties(data.props.map(item => {\n                            // при добавлении новой хар-ки свойство append принимает значение true\n                            // при изменении старой хар-ки свойство change принимает значение true\n                            // при удалении старой хар-ки свойство remove принимает значение true\n                            return {...item, unique: uuid(), append: false, remove: false, change: false}\n                        }))\n                    }\n                )\n                .catch(\n                    error => alert(error.response.data.message)\n                )\n            // нужно получить с сервера список категорий и список брендов\n            fetchCategories()\n                .then(\n                    data => setCategories(data)\n                )\n            fetchBrands()\n                .then(\n                    data => setBrands(data)\n                )\n        }\n    }, [id])\n\n    const handleInputChange = (event) => {\n        const data = {...value, [event.target.name]: event.target.value}\n        setValue(data)\n        setValid(isValid(data))\n    }\n\n    const handleImageChange = (event) => {\n        setImage(event.target.files[0])\n    }\n\n    const handleSubmit = async (event) => {\n        event.preventDefault()\n\n        /*\n         * На первый взгляд кажется, что переменная correct не нужна, можно обойтись valid, но это\n         * не так. Нельзя использовать значение valid сразу после изменения этого значения — ф-ция\n         * setValid не изменяет значение состояния мгновенно. Вызов функции лишь означает — React\n         * «принял к сведению» наше сообщение, что состояние нужно изменить.\n         */\n        const correct = isValid(value)\n        setValid(correct)\n\n        // если введенные данные прошли проверку — можно отправлять их на сервер\n        if (correct.name && correct.price && correct.category && correct.brand) {\n            const data = new FormData()\n            data.append('name', value.name.trim())\n            data.append('price', value.price.trim())\n            data.append('categoryId', value.category)\n            data.append('brandId', value.brand)\n            if (image) data.append('image', image, image.name)\n\n            // нужно обновить, добавить или удалить характеристики и обязательно дождаться\n            // ответа сервера — поэтому функция updateProperties() объявлена как async, а\n            // в теле функции для выполнения действия с каждой хар-кой используется await\n            if (properties.length) {\n                await updateProperties(properties, id)\n            }\n\n            updateProduct(id, data)\n                .then(\n                    data => {\n                        // сбрасываем поле загрузки изображения, чтобы при сохранении товара,\n                        // когда новое изображение не выбрано, не загружать старое повтороно\n                        event.target.image.value = ''\n                        // в принципе, мы могли бы сбросить все поля формы на дефолтные значения, но\n                        // если пользователь решит отредатировать тот же товар повтороно, то увидит\n                        // пустые поля формы — http-запрос на получение данных для редактирования мы\n                        // выполняем только тогда, когда выбран новый товар (изменился id товара)\n                        const prod = {\n                            name: data.name,\n                            price: data.price.toString(),\n                            category: data.categoryId.toString(),\n                            brand: data.brandId.toString()\n                        }\n                        setValue(prod)\n                        setValid(isValid(prod))\n                        // мы получим актуальные значения хар-тик с сервера, потому что обновление\n                        // хар-тик завершилось еще до момента отправки этого http-запроса на сервер\n                        setProperties(data.props.map(item => {\n                            return {...item, unique: uuid(), append: false, remove: false, change: false}\n                        }))\n                        // закрываем модальное окно редактирования товара\n                        setShow(false)\n                        // изменяем состояние, чтобы обновить список товаров\n                        setChange(state => !state)\n                    }\n                )\n                .catch(\n                    error => alert(error.response.data.message)\n                )\n        }\n    }\n\n    return (\n        <Modal show={show} onHide={() => setShow(false)} size=\"lg\">\n            <Modal.Header closeButton>\n                <Modal.Title>Редактирование товара</Modal.Title>\n            </Modal.Header>\n\n            <Modal.Body>\n                <Form noValidate onSubmit={handleSubmit}>\n                    <Form.Control\n                        name=\"name\"\n                        value={value.name}\n                        onChange={e => handleInputChange(e)}\n                        isValid={valid.name === true}\n                        isInvalid={valid.name === false}\n                        placeholder=\"Название товара...\"\n                        className=\"mb-3\"\n                    />\n                    <Row className=\"mb-3\">\n                        <Col>\n                            <Form.Select\n                                name=\"category\"\n                                value={value.category}\n                                onChange={e => handleInputChange(e)}\n                                isValid={valid.category === true}\n                                isInvalid={valid.category === false}\n                            >\n                                <option value=\"\">Категория</option>\n                                {categories && categories.map(item =>\n                                    <option key={item.id} value={item.id}>{item.name}</option>\n                                )}\n                            </Form.Select>\n                        </Col>\n                        <Col>\n                            <Form.Select\n                                name=\"brand\"\n                                value={value.brand}\n                                onChange={e => handleInputChange(e)}\n                                isValid={valid.brand === true}\n                                isInvalid={valid.brand === false}\n                            >\n                                <option value=\"\">Бренд</option>\n                                {brands && brands.map(item =>\n                                    <option key={item.id} value={item.id}>{item.name}</option>\n                                )}\n                            </Form.Select>\n                        </Col>\n                    </Row>\n                    <Row className=\"mb-3\">\n                        <Col>\n                            <Form.Control\n                                name=\"price\"\n                                value={value.price}\n                                onChange={e => handleInputChange(e)}\n                                isValid={valid.price === true}\n                                isInvalid={valid.price === false}\n                                placeholder=\"Цена товара...\"\n                            />\n                        </Col>\n                        <Col>\n                            <Form.Control\n                                name=\"image\"\n                                type=\"file\"\n                                onChange={e => handleImageChange(e)}\n                                placeholder=\"Фото товара...\"\n                            />\n                        </Col>\n                    </Row>\n                    <UpdateProperties properties={properties} setProperties={setProperties} />\n                    <Row>\n                        <Col>\n                            <Button type=\"submit\">Сохранить</Button>\n                        </Col>\n                    </Row>\n                </Form>\n            </Modal.Body>\n        </Modal>\n    )\n}\n\nexport default UpdateProduct"]},"metadata":{},"sourceType":"module"}